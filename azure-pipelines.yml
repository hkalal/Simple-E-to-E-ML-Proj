
trigger:
- main

pool: AzureAgentPool

stages:
- stage: 'Build'
  displayName: 'Build'
  jobs:
     - job: 
       steps:
       
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)/Programming'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            replaceExistingArchive: true
          displayName: "ZIPing source files"

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: 'drop-Artifacts'
            publishLocation: 'Container'
          displayName: "Publish-Build-Artifacts"
          

- stage: Deploy
  displayName: 'Deploy Web App'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeploymentJob
    pool:
      name: AzureAgentPool
    environment: class16July2024
    strategy:
      runOnce: 
        deploy:
          steps:
          - task: CopyFiles@2
            inputs:
              sourceFolder: '$(Build.ArtifactStagingDirectory)/..\drop-Artifacts'  # Path to your built artifacts
              targetFolder: 'C:\Deployment\MyApplication'  # Local deployment path on the server
              contents: | 
                - '**/*' 
          
          - task: PowerShell@2
            inputs:
              script: | 
                # Unzip the file to the target directory
                $zipFile = "C:\Deployment\MyApplication\*.zip"  # Specify the name of the zip file
                $destination = "C:\Deployment\MyApplication\"  # Directory to unzip to
                if (Test-Path $zipFile) {
                    Expand-Archive -Path $zipFile -DestinationPath $destination -Force
                    Write-Host "Unzipped $zipFile to $destination"
                } else {
                    Write-Host "Zip file not found: $zipFile"
                }